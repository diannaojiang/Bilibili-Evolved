!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["video/play-in-mpv"]=t():e["video/play-in-mpv"]=t()}(self,(function(){return function(){var e={335:function(e,t,n){var i=n(645)((function(e){return e[1]}));i.push([e.id,".play-mpv-panel {\n  font-size: 12px;\n  top: 100px;\n  left: 50%;\n  transform: translateX(-50%) scale(0.95);\n  transition: 0.2s ease-out;\n  z-index: 1000;\n  width: 320px;\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n  padding: 12px;\n  background-color: #fff;\n  color: black;\n  border-radius: 8px;\n  box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.05);\n  border: 1px solid rgba(136,136,136,0.13333);\n  box-sizing: border-box;\n}\nbody.dark .play-mpv-panel {\n  background-color: #282828;\n  color: #eee;\n  box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.2);\n}\n.play-mpv-panel.open {\n  transform: translateX(-50%);\n}\n.play-mpv-panel > :not(:first-child) {\n  margin-top: 12px;\n}\n.play-mpv-panel .be-textbox,\n.play-mpv-panel .be-textarea {\n  flex-grow: 1;\n}\n.play-mpv-panel-header {\n  display: flex;\n  align-items: center;\n  grid-gap: 0;\n  gap: 0;\n  align-self: stretch;\n}\n.play-mpv-panel-header .title {\n  font-size: 16px;\n  font-weight: bold;\n  flex-grow: 1;\n  margin: 0 8px;\n}\n.play-mpv-panel-header .be-button {\n  padding: 4px;\n}\n.play-mpv-panel .play-mpv-config-item {\n  display: flex;\n  align-items: center;\n  grid-gap: 0;\n  gap: 0;\n}\n.play-mpv-panel .play-mpv-config-item .play-mpv-config-title {\n  margin-right: 8px;\n}\n.play-mpv-panel .play-mpv-config-item.error {\n  color: #E57373;\n}\n.play-mpv-panel .play-mpv-config-section {\n  align-self: stretch;\n}\n.play-mpv-panel .play-mpv-config-description {\n  opacity: 0.5;\n  margin-top: 4px;\n}\n.play-mpv-panel-footer {\n  align-self: stretch;\n  justify-content: center;\n  display: flex;\n  align-items: center;\n  grid-gap: 0;\n  gap: 0;\n}\n.play-mpv-panel .run-download {\n  font-size: 13px;\n  padding: 6px 12px;\n}",""]),e.exports=i},482:function(e,t,n){var i=n(645)((function(e){return e[1]}));i.push([e.id,".episodes-picker-header {\n  display: flex;\n  align-items: center;\n  grid-gap: 0;\n  gap: 0;\n}\n.episodes-picker-checked-ratio {\n  flex-grow: 1;\n  margin-left: 4px;\n}\n.episodes-picker-actions {\n  display: flex;\n  align-items: center;\n  grid-gap: 0;\n  gap: 0;\n}\n.episodes-picker-actions .be-button {\n  padding: 4px;\n}\n.episodes-picker-actions .be-button.invert-selection .be-icon {\n  font-size: 14px;\n}\n.episodes-picker-actions .be-button.select-all .be-icon, .episodes-picker-actions .be-button.deselect-all .be-icon {\n  transform: translateY(1px);\n}\n.episodes-picker-items {\n  max-height: 400px;\n  overflow: auto;\n}\n.episodes-picker-items:not(:empty) {\n  margin-top: 4px;\n  border: 1px solid rgba(136,136,136,0.26667);\n  border-radius: 6px;\n}\n.episodes-picker-items .be-check-box {\n  padding: 2px 6px;\n}\n.episodes-picker-items .episode-duration {\n  margin-right: 4px;\n  text-align: right;\n  flex: 1 1 0;\n  opacity: 0.5;\n}",""]),e.exports=i},677:function(e,t,n){var i=n(645)((function(e){return e[1]}));i.push([e.id,".single-video-info.play-mpv-config-section {\n  height: 125px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n.single-video-info.play-mpv-config-section img {\n  height: 125px;\n  -o-object-fit: contain;\n     object-fit: contain;\n  border-radius: 8px;\n}\n.single-video-info.play-mpv-config-section img.shadow {\n  position: absolute;\n  filter: blur(8px) brightness(0.8);\n  transform: scaleY(0.95) translateY(4px);\n  z-index: -1;\n  opacity: 0.3;\n}",""]),e.exports=i},645:function(e){"use strict";
// eslint-disable-next-line func-names
e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=e(t);return t[2]?"@media ".concat(t[2]," {").concat(n,"}"):n})).join("")},
// eslint-disable-next-line func-names
t.i=function(e,n,i){"string"==typeof e&&(
// eslint-disable-next-line no-param-reassign
e=[[null,e,""]]);var s={};if(i)for(var a=0;a<this.length;a++){
// eslint-disable-next-line prefer-destructuring
var o=this[a][0];null!=o&&(s[o]=!0)}for(var r=0;r<e.length;r++){var l=[].concat(e[r]);i&&s[l[0]]||(n&&(l[2]?l[2]="".concat(n," and ").concat(l[2]):l[2]=n),t.push(l))}},t}},379:function(e,t,n){"use strict";var i,s=function(){return void 0===i&&(
// @see http://browserhacks.com/#hack-e71d8692f65334173fee715c222cb805
// @see https://github.com/webpack-contrib/style-loader/issues/177
i=Boolean(window&&document&&document.all&&!window.atob)),i},a=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}(),o=[];function r(e){for(var t=-1,n=0;n<o.length;n++)if(o[n].identifier===e){t=n;break}return t}function l(e,t){for(var n={},i=[],s=0;s<e.length;s++){var a=e[s],l=t.base?a[0]+t.base:a[0],c=n[l]||0,p="".concat(l," ").concat(c);n[l]=c+1;var d=r(p),u={css:a[1],media:a[2],sourceMap:a[3]};-1!==d?(o[d].references++,o[d].updater(u)):o.push({identifier:p,updater:v(u,t),references:1}),i.push(p)}return i}function c(e){var t=document.createElement("style"),i=e.attributes||{};if(void 0===i.nonce){var s=n.nc;s&&(i.nonce=s)}if(Object.keys(i).forEach((function(e){t.setAttribute(e,i[e])})),"function"==typeof e.insert)e.insert(t);else{var o=a(e.insert||"head");if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(t)}return t}var p,d=(p=[],function(e,t){return p[e]=t,p.filter(Boolean).join("\n")});function u(e,t,n,i){var s=n?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(e.styleSheet)e.styleSheet.cssText=d(t,s);else{var a=document.createTextNode(s),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(a,o[t]):e.appendChild(a)}}function f(e,t,n){var i=n.css,s=n.media,a=n.sourceMap;if(s?e.setAttribute("media",s):e.removeAttribute("media"),a&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),e.styleSheet)e.styleSheet.cssText=i;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(i))}}var m=null,h=0;function v(e,t){var n,i,s;if(t.singleton){var a=h++;n=m||(m=c(t)),i=u.bind(null,n,a,!1),s=u.bind(null,n,a,!0)}else n=c(t),i=f.bind(null,n,t),s=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else s()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=s());var n=l(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var i=0;i<n.length;i++){var s=r(n[i]);o[s].references--}for(var a=l(e,t),c=0;c<n.length;c++){var p=r(n[c]);0===o[p].references&&(o[p].updater(),o.splice(p,1))}n=a}}}},785:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return ee}});var i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("VPopup",{staticClass:"play-mpv-panel",attrs:{"trigger-element":e.triggerElement},model:{value:e.open,callback:function(t){e.open=t},expression:"open"}},[n("div",{staticClass:"play-mpv-panel-header"},[n("VIcon",{attrs:{icon:"mdi-download"}}),e._v(" "),n("div",{staticClass:"title"},[e._v("\n      MPV播放\n    ")]),e._v(" "),n("VButton",{attrs:{type:"transparent",title:"关闭"},on:{click:function(t){e.open=!1}}},[n("VIcon",{attrs:{icon:"mdi-close",size:20}})],1)],1),e._v(" "),e.selectedInput?n("div",{staticClass:"play-mpv-config-item"},[n("div",{staticClass:"play-mpv-config-title"},[e._v("\n      输入源:\n    ")]),e._v(" "),n("VDropdown",{attrs:{items:e.inputs},model:{value:e.selectedInput,callback:function(t){e.selectedInput=t},expression:"selectedInput"}})],1):e._e(),e._v(" "),0===e.inputs.length?n("div",{staticClass:"play-mpv-config-item error"},[e._v("\n    没有匹配的输入源, 请确保安装了适合此页面的插件.\n  ")]):e._e(),e._v(" "),e.selectedInput&&e.selectedInput.component?n(e.selectedInput.component,{ref:"inputOptions",tag:"component"}):e._e(),e._v(" "),e.selectedApi?n("div",{staticClass:"play-mpv-config-item"},[n("div",{staticClass:"play-mpv-config-title"},[e._v("\n      格式:\n    ")]),e._v(" "),n("VDropdown",{attrs:{items:e.apis},model:{value:e.selectedApi,callback:function(t){e.selectedApi=t},expression:"selectedApi"}})],1):e._e(),e._v(" "),e.selectedApi&&e.selectedApi.description?n("div",{staticClass:"play-mpv-config-description",domProps:{innerHTML:e._s(e.selectedApi.description)}}):e._e(),e._v(" "),e.selectedQuality?n("div",{staticClass:"play-mpv-config-item"},[n("div",{staticClass:"play-mpv-config-title"},[e._v("\n      清晰度:\n    ")]),e._v(" "),n("VDropdown",{attrs:{items:e.filteredQualities},on:{change:function(t){return e.saveSelectedQuality()}},model:{value:e.selectedQuality,callback:function(t){e.selectedQuality=t},expression:"selectedQuality"}})],1):e._e(),e._v(" "),!e.testData.multiple&&e.selectedQuality?[e.testData.videoInfo?n("div",{staticClass:"play-mpv-config-description"},[e._v("\n      预计大小: "+e._s(e.formatFileSize(e.testData.videoInfo.totalSize))+"\n    ")]):e._e(),e._v(" "),null===e.testData.videoInfo?n("div",{staticClass:"play-mpv-config-description"},[e._v("\n      正在计算大小\n    ")]):e._e()]:e._e(),e._v(" "),e._l(e.assetsWithOptions,(function(e){return n(e.component,{key:e.name,ref:"assetsOptions",refInFor:!0,tag:"component",attrs:{name:e.name}})})),e._v(" "),e.selectedOutput?n("div",{staticClass:"play-mpv-config-item"},[n("div",{staticClass:"play-mpv-config-title"},[e._v("\n      输出方式:\n    ")]),e._v(" "),n("VDropdown",{attrs:{items:e.outputs},model:{value:e.selectedOutput,callback:function(t){e.selectedOutput=t},expression:"selectedOutput"}})],1):e._e(),e._v(" "),e.selectedOutput&&e.selectedOutput.description?n("div",{staticClass:"play-mpv-config-description"},[e._v("\n    "+e._s(e.selectedOutput.description)+"\n  ")]):e._e(),e._v(" "),e.selectedOutput&&e.selectedOutput.component?n(e.selectedOutput.component,{ref:"outputOptions",tag:"component"}):e._e(),e._v(" "),n("div",{staticClass:"play-mpv-panel-footer"},[n("VButton",{staticClass:"run-download",attrs:{type:"primary",disabled:!e.canStartDownload},on:{click:function(t){return e.startDownload(e.$refs.outputOptions,e.selectedOutput)}}},[e._v("\n      开始\n    ")])],1)],2)};i._withStripped=!0;var s=coreApis.settings,a=coreApis.utils,o=n(729),r=coreApis.utils.formatters,l=coreApis.ui,c=coreApis.pluginApis.data,p=coreApis.componentApis.video.videoQuality,d=coreApis.toast,u=coreApis.ajax,f=coreApis.utils.title,m=coreApis.utils.urls,h=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"episodes-picker play-mpv-config-section"},[n("div",{staticClass:"episodes-picker-header"},[n("div",{staticClass:"episodes-picker-title"},[e._v("\n      选集:\n    ")]),e._v(" "),n("div",{staticClass:"episodes-picker-checked-ratio"},[e._v("\n      "+e._s(e.checkedRatio)+"\n    ")]),e._v(" "),n("div",{staticClass:"episodes-picker-actions"},[n("VButton",{staticClass:"select-all",attrs:{title:"全选",type:"transparent"},on:{click:function(t){e.forEachItem((function(e){return e.isChecked=!0}))}}},[n("VIcon",{attrs:{size:16,icon:"mdi-checkbox-multiple-marked-circle"}})],1),e._v(" "),n("VButton",{staticClass:"deselect-all",attrs:{title:"全不选",type:"transparent"},on:{click:function(t){e.forEachItem((function(e){return e.isChecked=!1}))}}},[n("VIcon",{attrs:{size:16,icon:"mdi-checkbox-multiple-blank-circle-outline"}})],1),e._v(" "),n("VButton",{staticClass:"invert-selection",attrs:{title:"反选",type:"transparent"},on:{click:function(t){e.forEachItem((function(e){return e.isChecked=!e.isChecked}))}}},[n("VIcon",{attrs:{size:16,icon:"mdi-circle-slice-4"}})],1)],1)]),e._v(" "),n("div",{staticClass:"episodes-picker-items"},e._l(e.episodeItems,(function(t,i){return n("div",{key:t.key,staticClass:"episodes-picker-item"},[n("CheckBox",{attrs:{"icon-position":"left","data-aid":t.inputItem.aid,"data-cid":t.inputItem.cid,"data-bvid":t.inputItem.bvid},nativeOn:{click:function(n){return e.shiftSelect(n,t,i)}},model:{value:t.isChecked,callback:function(n){e.$set(t,"isChecked",n)},expression:"item.isChecked"}},[n("span",{staticClass:"episode-title"},[e._v("\n          "+e._s(t.title)+"\n        ")]),e._v(" "),t.durationText?n("span",{staticClass:"episode-duration"},[e._v("\n          "+e._s(t.durationText)+"\n        ")]):e._e()])],1)})),0)])};h._withStripped=!0;var v=Vue.extend({components:{VButton:l.VButton,VIcon:l.VIcon,CheckBox:l.CheckBox},props:{api:{type:Function,required:!0}},data:()=>({episodeItems:[],maxCheckedItems:32,lastCheckedEpisodeIndex:-1}),computed:{checkedRatio(){return`(${this.episodeItems.filter((e=>e.isChecked)).length}/${this.episodeItems.length})`},inputItems(){return this.episodeItems.map((e=>e.inputItem))},checkedInputItems(){return this.episodeItems.filter((e=>e.isChecked)).map((e=>e.inputItem))}},created(){this.getEpisodeItems()},methods:{shiftSelect(e,t,n){e.shiftKey&&-1!==this.lastCheckedEpisodeIndex?e.shiftKey&&-1!==this.lastCheckedEpisodeIndex&&(this.episodeItems.slice(Math.min(this.lastCheckedEpisodeIndex,n)+1,Math.max(this.lastCheckedEpisodeIndex,n)).forEach((e=>{e.isChecked=!e.isChecked})),this.lastCheckedEpisodeIndex=n,e.preventDefault()):this.lastCheckedEpisodeIndex=n},forEachItem(e){this.episodeItems.forEach(e)},async getEpisodeItems(){this.episodeItems.length>0||(this.episodeItems=await this.api(this))}}}),g=n(379),y=n.n(g),b=n(482),x=n.n(b),_={insert:"head",singleton:!1},w=(y()(x(),_),x().locals,n(900)),I=(0,w.Z)(v,h,[],!1,null,null,null);I.options.__file="registry/lib/components/video/play-in-mpv/inputs/EpisodesPicker.vue";var k=I.exports;const C=e=>Vue.extend({computed:{checkedInputItems(){return this.$refs.picker.checkedInputItems}},render:t=>t(k,{props:{api:e},ref:"picker"})}),V={name:"bangumi.batch",displayName:"当前番剧 (多P)",match:m.bangumiUrls,getInputs:async e=>e?.checkedInputItems??[],component:async()=>C((async e=>{const t=document.querySelector("meta[property='og:url']");if(null===t)return(0,o.logError)("获取番剧数据失败: 无法找到 Season ID"),[];const n=t.getAttribute("content")?.match(/play\/ss(\d+)/)?.[1];if(void 0===n)return(0,o.logError)("获取番剧数据失败: 无法解析 Season ID"),[];const i=await(0,u.getJson)(`https://api.bilibili.com/pgc/web/season/section?season_id=${n}`);if(0!==i.code)return(0,o.logError)(`获取番剧数据失败: 无法获取番剧集数列表, message=${i.message}`),[];const a=i.result.main_section.episodes;return a.map(((t,n)=>{const i=t.long_title?t.title:(n+1).toString(),o=t.long_title?t.long_title:t.title;return{key:t.cid,title:`${i} - ${o}`,isChecked:n<e.maxCheckedItems,inputItem:{aid:t.aid,cid:t.cid,title:(0,f.formatTitle)((0,s.getGeneralSettings)().batchFilenameFormat,!1,{ep:o,cid:t.cid,aid:t.aid,n:(0,r.formatNumber)(parseFloat(i),a.length)??o}),allowQualityDrop:!0}}}))}))},A={name:"video.batch",displayName:"当前视频 (多P)",match:m.videoUrls,getInputs:async e=>e?.checkedInputItems??[],component:async()=>C((async e=>{const{aid:t}=unsafeWindow,n=`https://api.bilibili.com/x/web-interface/view?aid=${t}`,i=await(0,u.getJson)(n);if(0!==i.code)return(0,o.logError)(`获取视频选集列表失败, message = ${i.message}`),[];const{pages:a}=i.data;return void 0===a?((0,o.logError)("获取视频选集列表失败, 没有找到选集信息."),[]):a.map(((n,i)=>({key:n.cid,title:`P${n.page} ${n.part}`,isChecked:i<e.maxCheckedItems,durationText:(0,r.formatDuration)(n.duration),inputItem:{allowQualityDrop:!0,title:(0,f.formatTitle)((0,s.getGeneralSettings)().batchFilenameFormat,!1,{cid:n.cid,n:(0,r.formatNumber)(n.page,a.length),ep:n.part}),cid:n.cid,aid:t}})))}))},E={name:"video",displayName:"当前视频",match:m.videoUrls,getInputs:async()=>[{aid:unsafeWindow.aid,cid:unsafeWindow.cid,title:(0,f.getFriendlyTitle)(!0)}],component:()=>Promise.resolve().then(n.bind(n,477)).then((e=>e.default))};var D=coreApis.utils.sort;const S=(e,t)=>{e.quality&&t.currentQuality.value!==e.quality.value&&(e.allowQualityDrop?console.warn(`'${e.title}' 不支持选择的清晰度${e.quality.displayName}, 已降级为${t.currentQuality.displayName}`):(e=>{if(p.vipRequiredQualities.find((t=>t.value===e)))throw new Error("您选择的清晰度需要大会员, 请更改清晰度后重试.");if(p.loginRequiredQualities.find((t=>t.value===e)))throw new Error("您选择的清晰度需要先登录.");throw new Error("获取下载链接失败, 请尝试更换清晰度或更换格式.")})(e.quality.value))};var $=coreApis.download;function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class O{constructor(e){M(this,"input",void 0),M(this,"fragments",void 0),M(this,"qualities",void 0),M(this,"currentQuality",void 0),M(this,"jsonData",void 0),Object.assign(this,e)}get totalSize(){return lodash.sumBy(this.fragments,(e=>e.size))}get totalLength(){return lodash.sumBy(this.fragments,(e=>e.length))}get titledFragments(){return this.fragments.map(((e,t)=>{const n=this.fragments.filter((t=>t.extension===e.extension)).length>1?` - ${(0,r.formatNumber)(t+1,this.fragments.length)}`:"";return{...e,title:`${this.input.title}${n}${e.extension}`}}))}}class P{constructor(e){this.infos=e,M(this,"inputs",[]),M(this,"extraAssets",[]),this.inputs=e.map((e=>e.input))}get isSingleVideo(){return this.inputs.length<2}async downloadExtraAssets(){console.log("[downloadExtraAssets]",this.extraAssets);const e=`${(0,f.getFriendlyTitle)(!1)}.zip`;await new $.DownloadPackage(this.extraAssets).emit(e)}}
/* spell-checker: disable */
const q={video:".mp4",audio:".m4a"},Q=e=>({url:e.downloadUrl,backupUrls:e.backupUrls,length:e.duration,size:Math.trunc(e.bandWidth*e.duration/8),extension:q[e.type]??".m4s"}),T=async(e,t)=>{const{codec:n="AVC/H.264",filters:i}=t,s={video:()=>!0,audio:()=>!0,...i},{aid:o,cid:r,quality:l}=e,c={avid:o,cid:r,qn:l?.value??"",otype:"json",fourk:1,fnver:0,fnval:2e3},d=`https://api.bilibili.com/x/player/playurl?${(0,a.formData)(c)}`,f=await(0,u.bilibiliApi)((0,u.getJsonWithCredentials)(d),"获取视频链接失败");if(!f.dash)throw new Error("此视频没有 dash 格式, 请改用其他格式.");const m=p.allQualities.find((e=>e.value===f.quality)),{duration:h,video:v,audio:g}=f.dash,y=v.filter((e=>e.id===m.value)).map((e=>{const t=(()=>{switch(e.codecid){case 12:return"HEVC/H.265";default:case 7:return"AVC/H.264"}})();return{type:"video",quality:m,width:e.width,height:e.height,codecs:e.codecs,codecId:e.codecid,bandWidth:e.bandwidth,frameRate:e.frameRate,backupUrls:(e.backupUrl||e.backup_url||[]).map((e=>e.replace("http:","https:"))),downloadUrl:(e.baseUrl||e.base_url||"").replace("http:","https:"),duration:h,videoCodec:t}})).filter((e=>s.video(e))),b=(e=>{const{videoDashes:t,audioDashes:n,videoCodec:i}=e,s=[];if(0!==t.length){const e=e=>e.videoCodec===i;if(t.some(e)){const n=t.filter(e).sort((0,D.ascendingSort)((e=>e.bandWidth)))[0];s.push(Q(n))}else s.push(Q(t.sort((0,D.ascendingSort)((e=>e.bandWidth)))[0]))}if(0!==n.length){const e=n.sort((0,D.descendingSort)((e=>e.bandWidth)))[0];s.push(Q(e))}return s})({audioDashes:(g||[]).map((e=>({type:"audio",bandWidth:e.bandwidth,codecs:e.codecs,codecId:e.codecid,backupUrls:(e.backupUrl||e.backup_url||[]).map((e=>e.replace("http:","https:"))),downloadUrl:(e.baseUrl||e.base_url||"").replace("http:","https:"),duration:h}))).filter((e=>s.audio(e))),videoDashes:y,videoCodec:n}),x=f.accept_quality.map((e=>p.allQualities.find((t=>t.value===e)))).filter((e=>void 0!==e)),_=new O({input:e,jsonData:f,fragments:b,qualities:x,currentQuality:m});return S(e,_),_},j={name:"video.dash.avc",displayName:"dash (AVC/H.264)",description:"音画分离的 mp4 格式, 编码为 H.264, 兼容性较好. 下载后可以合并为单个 mp4 文件.",playMpvInfo:async e=>T(e,{codec:"AVC/H.264"})},U={name:"video.dash.hevc",displayName:"dash (HEVC/H.265)",description:"音画分离的 mp4 格式, 编码为 H.265, 体积较小, 兼容性较差. 下载后可以合并为单个 mp4 文件.",playMpvInfo:async e=>T(e,{codec:"HEVC/H.265"})},N={name:"video.dash.audio",displayName:"dash (仅音频)",description:"仅MPV播放中的音频轨道.",playMpvInfo:async e=>T(e,{filters:{video:()=>!1}})},z=(e,t)=>{const n=e=>t.length>e?t[e]:t[t.length-1];return{fragments:e.durl.map(((e,t)=>({length:e.length,size:e.size,url:e.url,backupUrls:e.backup_url,extension:n(t)}))),qualities:e.accept_quality.map((e=>p.allQualities.find((t=>t.value===e)))).filter((e=>void 0!==e)),currentQuality:p.allQualities.find((t=>t.value===e.quality))}},B={name:"video.flv",displayName:"flv",description:"使用 flv 格式下载, 兼容 H.264 编码.",playMpvInfo:async e=>{const{aid:t,cid:n,quality:i}=e,s={avid:t,cid:n,qn:i?.value??"",otype:"json",fourk:1,fnver:0,fnval:0},o=`https://api.bilibili.com/x/player/playurl?${(0,a.formData)(s)}`,r=await(0,u.bilibiliApi)((0,u.getJsonWithCredentials)(o),"获取视频链接失败"),l=new O({input:e,jsonData:r,...z(r,[".flv"])});return S(e,l),l}},W={name:"consoleLogDemo",displayName:"Toast",description:"弹一条消息显示出播放按钮，点击即可使用MPV进行播放",runAction:async e=>{const t=e.infos.flatMap((e=>e.titledFragments)),n=t.map((e=>e.url)).join("\n"),i='mpv://--http-header-fields="referer:https://www.bilibili.com/" "'+t[0].url+'" --audio-file="'+t[1].url+'"';console.log(i),d.Toast.show(`<a class="link" href="${encodeURI(i)}" >播放</a>`,"MPV播放"),console.log(n),console.log(e)}},[F]=(0,c.registerAndGetData)("playMpv.inputs",[E,A,V]),[H]=(0,c.registerAndGetData)("playMpv.apis",[B,j,U,N]),[R]=(0,c.registerAndGetData)("playMpv.assets",[]),[G]=(0,c.registerAndGetData)("playMpv.outputs",[W]),{basicConfig:L}=(0,s.getComponentSettings)("playMpv").options;var J=Vue.extend({components:{VPopup:l.VPopup,VButton:l.VButton,VDropdown:l.VDropdown,VIcon:l.VIcon},props:{triggerElement:{required:!0}},data(){const e=L.api,t=L.output;return{open:!1,busy:!1,testData:{videoInfo:null,multiple:!1},assets:R,qualities:[],selectedQuality:void 0,inputs:[],selectedInput:void 0,apis:H,selectedApi:H.find((t=>t.name===e))||H[0],outputs:G,selectedOutput:G.find((e=>e.name===t))||G[0]}},computed:{assetsWithOptions(){return this.assets.filter((e=>e.component))},filteredQualities(){return 0===this.qualities.length?p.allQualities:this.qualities},canStartDownload(){if(this.busy||!this.open)return!1;return!Object.entries(this).filter((([e])=>e.startsWith("selected"))).some((([,e])=>!e))}},watch:{selectedInput(e){void 0!==e&&this.updateTestVideoInfo()},selectedApi(e){void 0!==e&&(this.updateTestVideoInfo(),L.api=e.name)},selectedOutput(e){void 0!==e&&(L.output=e.name)}},mounted(){coreApis.observer.videoChange((()=>{const e=F.filter((e=>e.match?.some((e=>(0,a.matchUrlPattern)(e)))??!0));this.inputs=e,this.selectedInput=e[0]}))},methods:{formatFileSize:r.formatFileSize,saveSelectedQuality(){const e=this.selectedQuality;void 0!==e&&(L.quality=e.value,this.updateTestVideoInfo())},async getVideoItems(){const e=this.selectedInput;return await e.getInputs(this.$refs.inputOptions)},async updateTestVideoInfo(){if(!this.selectedInput)return;this.testData.videoInfo=null;const e=await this.getVideoItems();console.log("[updateTestVideoInfo]",e),this.testData.multiple=e.length>1;const t=this.selectedApi,[n]=e;if(!this.selectedQuality){const e=await t.playMpvInfo(n);if(this.qualities=e.qualities,this.selectedQuality=e.qualities[0],L.quality){const[t]=e.qualities.filter((e=>e.value<=L.quality));t&&(this.selectedQuality=t)}}try{n.quality=this.selectedQuality;const e=await t.playMpvInfo(n);this.testData.videoInfo=e}catch(e){this.testData.videoInfo=void 0}},async startDownload(e,t){try{this.busy=!0;const n=this.selectedInput,i=this.selectedApi,s=await n.getInputs(this.$refs.inputOptions);if(0===s.length)return void d.Toast.info("未接收到视频, 如果输入源支持批量, 请至少选择一个视频.","MPV播放",3e3);s.forEach((e=>{e.quality=this.selectedQuality}));const a=await Promise.all(s.map((e=>i.playMpvInfo(e))));if(0===a.length||0===lodash.sumBy(a,(e=>e.fragments.length)))return void d.Toast.info("未接收到可下载数据, 请检查输入源和格式是否适用于当前视频.","MPV播放",3e3);const o=new P(a),r=(await Promise.all(R.map((e=>e.getAssets(a,this.$refs.assetsOptions.find((t=>t.$attrs.name===e.name))))))).flat();o.extraAssets.push(...r),await o.downloadExtraAssets(),await t.runAction(o,e)}catch(e){(0,o.logError)(e)}finally{this.busy=!1}}}}),Z=n(335),X=n.n(Z),Y={insert:"head",singleton:!1},K=(y()(X(),Y),X().locals,(0,w.Z)(J,i,[],!1,null,null,null));K.options.__file="registry/lib/components/video/play-in-mpv/PlayMpv.vue";var ee=K.exports},774:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return r}});var i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"multiple-widgets"},[n("DefaultWidget",{ref:"button",attrs:{name:"MPV播放",icon:"mdi-download"},on:{mouseover:function(t){return e.createDownloadPanel()},click:function(t){return e.toggleDownloadPanel()}}})],1)};let s;i._withStripped=!0;var a=Vue.extend({components:{DefaultWidget:coreApis.ui.DefaultWidget},methods:{async createDownloadPanel(){if(!s){const e=document.createElement("div");document.body.appendChild(e);const t=await Promise.resolve().then(n.bind(n,785)).then((e=>e.default));s=new t({propsData:{triggerElement:this.$refs.button}}).$mount(e)}},async toggleDownloadPanel(){s&&(s.open=!s.open)}}}),o=(0,n(900).Z)(a,i,[],!1,null,null,null);o.options.__file="registry/lib/components/video/play-in-mpv/Widget.vue";var r=o.exports},477:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return m}});var i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"single-video-info play-mpv-config-section"},[e.imageUrl?n("img",{staticClass:"shadow",attrs:{src:e.imageUrl}}):e._e(),e._v(" "),e.imageUrl?n("img",{attrs:{src:e.imageUrl}}):e._e()])};i._withStripped=!0;var s=coreApis.observer,a=n(729),o=coreApis.componentApis.video.videoInfo,r=Vue.extend({data:()=>({imageUrl:""}),created(){(0,s.videoChange)((async()=>{const{aid:e}=unsafeWindow,t=new o.VideoInfo(e);try{await t.fetchInfo()}catch(e){throw(0,a.logError)(e),e}this.imageUrl=t.coverUrl.replace("http:","https:")}))}}),l=n(379),c=n.n(l),p=n(677),d=n.n(p),u={insert:"head",singleton:!1},f=(c()(d(),u),d().locals,(0,n(900).Z)(r,i,[],!1,null,null,null));f.options.__file="registry/lib/components/video/play-in-mpv/inputs/video/SingleVideoInfo.vue";var m=f.exports},900:function(e,t,n){"use strict";function i(e,t,n,i,s,a,o,r){var l,c="function"==typeof e?e.options:e;if(t&&(c.render=t,c.staticRenderFns=n,c._compiled=!0),i&&(c.functional=!0),a&&(c._scopeId="data-v-"+a),o?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),s&&s.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(o)},c._ssrRegister=l):s&&(l=r?function(){s.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:s),l)if(c.functional){c._injectStyles=l;var p=c.render;c.render=function(e,t){return l.call(t),p(e,t)}}else{var d=c.beforeCreate;c.beforeCreate=d?[].concat(d,l):[l]}return{exports:e,options:c}}n.d(t,{Z:function(){return i}})},729:function(e){"use strict";e.exports=coreApis.utils.log}},t={};function n(i){var s=t[i];if(void 0!==s)return s.exports;var a=t[i]={id:i,exports:{}};return e[i](a,a.exports,n),a.exports}n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return function(){"use strict";n.d(i,{component:function(){return t}});var e=coreApis.spinQuery;const t={name:"playMpv",displayName:"MPV播放",description:"在功能面板中添加MPV播放支持。需本地程序设置支持。配置方法详见：https://github.com/diannaojiang/Bilibili-Playin-Mpv",entry:none,reload:none,unload:none,widget:{component:()=>Promise.resolve().then(n.bind(n,774)).then((e=>e.default)),condition:()=>(0,e.hasVideo)()},tags:[componentsTags.video],options:{basicConfig:{defaultValue:{},displayName:"基础配置",hidden:!0}},commitHash:"41ffbb0d55bf86d980dffedad09e4387181ce57d"}}(),i=i.component}()}));